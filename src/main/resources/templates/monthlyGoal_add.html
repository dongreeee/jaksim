<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link href="/styles.css" rel="stylesheet"/>
    <title>모바일 입력 폼</title>
    <style>
<!--        label {-->
<!--          display: block;-->
<!--          margin-top: 16px;-->
<!--          margin-bottom: 6px;-->
<!--          font-weight: bold;-->
<!--        }-->

         .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      margin-bottom: 6px;
    }
    .label-row label {
      font-weight: bold;
    }

     input[type="color"] {
      width: 30px;
      height: 30px;
      border: none;
      padding: 0;
      background: none;
      cursor: pointer;
    }

        input[type="text"],
        textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 8px;
          box-sizing: border-box;
          margin: 12px 0;
        }
        textarea {
          resize: vertical;
          min-height: 100px;
        }
        .save-btn {
          width: 100%;
          padding: 14px;
          font-size: 16px;
          background-color: black;
          color: white;
          cursor: pointer;
        }

    </style>
</head>
<body>
<div th:replace="~{nav.html::navbar}"></div>
<div class="container" style="margin-top:30px; padding:20px;">
    <div class="calendar-widget2" id="calendar3" style="width:100%;" >
        <!-- JavaScript로 채워짐 -->
    </div>
    <form id="monthlyForm" th:action="@{/monthlyGoal/addContent}" method="post" th:unless="${today}">


        <input type="hidden" class="goal-date" name="date" id="date" th:value="${date}">
        <!--      disabled는 값을 전달하지 않음   -->
        <input type="hidden" name="month" id="goal_month" th:value="${month}">
        <input type="hidden" name="goal_id" id="goal_id" >
        <div id="div_goal_add" style="display:none;">
            <input type="text" id="content" name="content" placeholder="오늘의 목표를 달성했나요? ">
            <button class="save-btn" type="submit" onclick="submitForm()">달 성 완 료</button>
        </div>

    </form>

    <div id="goal_content_list">

    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <span class="close-btn" onclick="closeModal()">×</span>
            <input type="text" name="goal_title" id="goal_title" placeholder="목표를 입력하세요" />
            <button class="modal-btn" onclick="goalMonthly()">저장하기</button>
        </div>
    </div>

</div>



<!-- STOMP & SockJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- 공통 WebSocket 연결 스크립트 -->
<script src="/common.js"></script>

<script>
    const monthlyForm = document.getElementById('monthlyForm');
 if (monthlyForm) {
     monthlyForm.addEventListener('submit', function (event) {
         const content = document.getElementById('content').value.trim();
         if (!content) {
             alert("내용은 필수입니다.");
             event.preventDefault();
         }
     });
 }

</script>

<script>

  let allowedMonths = [];      // 서버에서 받은 데이터 존재 월 목록 (['2025-07','2025-08',...])
  let minAllowedYm = null;     // 기록 시작(최초 월) 'YYYY-MM'
  let maxAllowedYm = null;     // 현재 달 'YYYY-MM'
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth(); // 0 ~ 11

   // 유틸: YYYY-MM 문자열 비교 (a < b => -1, a==b => 0, a>b => 1)
    function compareYm(a, b) {
      if (!a || !b) return 0;
      const [ay, am] = a.split('-').map(Number);
      const [by, bm] = b.split('-').map(Number);
      if (ay !== by) return ay < by ? -1 : 1;
      if (am !== bm) return am < bm ? -1 : 1;
      return 0;
    }

    // 현재 달 YYYY-MM
    function getCurrentYmString() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }


    document.addEventListener('DOMContentLoaded', function () {
       // maxAllowedYm은 "현재달"로 고정
       maxAllowedYm = getCurrentYmString();
       fetchGoalDatesAndRender3();
    });

  // 달력 렌더링 (버튼 disabled 처리 포함)
  function renderCalendar3() {
    const today = new Date();
    const calendar = document.getElementById('calendar3');

    const year = currentYear;
    const month = currentMonth;
    const date = today.getDate();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const monthName = `${month + 1}`;

  // 현재 보고 있는 ym
      const currentYm = `${year}-${String(month + 1).padStart(2, '0')}`;

      // 버튼 활성 여부 판단
      const leftDisabled = (minAllowedYm && compareYm(currentYm, minAllowedYm) <= 0) ? 'disabled' : '';
      const rightDisabled = (maxAllowedYm && compareYm(currentYm, maxAllowedYm) >= 0) ? 'disabled' : '';

      calendar.innerHTML = `
        <div class='slide-bar-monthly'>
          <button id="btn-prev" onclick="changeMonth(-1)" ${leftDisabled}>←</button>
          <h3>${year}년 ${monthName}월</h3>
          <button id="btn-next" onclick="changeMonth(1)" ${rightDisabled}>→</button>
          <span id="goal_add" onclick="openModal()"> 목표 지정하기 + </span>
          <span id="goal_update" style="display:none;"></span>
        </div>
      `;

  const days = document.createElement('div');
  days.className = 'days';

  const dayNames = ['월', '화', '수', '목', '금', '토', '일'];
  dayNames.forEach(name => {
    const d = document.createElement('div');
    d.className = 'day-header';
    d.textContent = name;
    days.appendChild(d);

  });

  const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        days.appendChild(empty);
      }

      for (let i = 1; i <= lastDay.getDate(); i++) {
        const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const d = document.createElement('div');
        d.className = 'day';

        if (i === date && month === today.getMonth() && year === today.getFullYear()) {
          d.classList.add('today');
        }

        if (emojiMap[fullDate]) {
          d.innerHTML = `<span class="emoji-day">${emojiMap[fullDate]}</span>`;
        } else {
          d.textContent = i;
        }

        days.appendChild(d);
      }

      calendar.appendChild(days);

// 렌더 후 해당 월의 타이틀 목표 불러오기
      fetchMonthlyGoalView(year, month + 1); // month는 0~11이므로 +1

}

// 월 변경 함수: 범위 벗어나면 alert
function changeMonth(offset) {
  let nextMonth = currentMonth + offset;
  let nextYear = currentYear;

  if (nextMonth < 0) {
    nextMonth = 11;
    nextYear -= 1;
  } else if (nextMonth > 11) {
    nextMonth = 0;
    nextYear += 1;
  }

  const nextYm = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}`;

  // 범위 검사: minAllowedYm <= nextYm <= maxAllowedYm
      if (minAllowedYm && compareYm(nextYm, minAllowedYm) < 0) {
        alert('기록이 시작된 최초 달 이전으로는 이동할 수 없습니다.');
        return;
      }
      if (maxAllowedYm && compareYm(nextYm, maxAllowedYm) > 0) {
        alert('현재 달 이후로는 이동할 수 없습니다.');
        return;
      }

      // 허용 범위 내이면 변경
      currentMonth = nextMonth;
      currentYear = nextYear;
      renderCalendar3();
    }


        function openModal() {
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('goal_title').value = '';
      document.getElementById('modalOverlay').style.display = 'none';

    }
// 서버에서 목표 날짜 및 allowedMonths 가져오기
    function fetchGoalDatesAndRender3() {
       fetch('/monthlyGoal/goalCount')  // 날짜만 주는 API
         .then(res => res.json())
//        날짜 배열을 받아서 각 날짜를 키로 하고 값은 항상 emoji인 객체(맵) 형태로 바꿔주는 것
         .then(data => {
          const goalDates = data.goalDates || [];       // ['2025-07-01', '2025-07-12', ...]
          const allowed = data.allowedMonths || [];     // ['2025-07', '2025-08']

         console.log('goalcount옴');
           // 모든 날짜에 동일 이모지 할당
//           dates : ["2025-07-28", "2025-08-02"] 같은 배열
//           acc : 객체를 누적할 객체 (초기값 : {})
//           date : 현재 순회 중인 날짜 문자열
          // 날짜->이모지 맵 생성
          emojiMap = goalDates.reduce((acc, date) => {
            acc[date] = '🌟';
            return acc;
          }, {});
        // allowedMonths 저장 (이번달 포함 + 중복 제거는 서버에서 처리)
           allowedMonths = allowed;

           // minAllowedYm 계산: allowedMonths 중 가장 이른 값
          if (allowedMonths.length > 0) {
            // YYYY-MM이므로 문자열 정렬로도 가능
            const sorted = allowedMonths.slice().sort();
            minAllowedYm = sorted[0];
          } else {
            // 기록이 없으면 min을 현재 달로 설정(이전으로 못가게)
            minAllowedYm = getCurrentYmString();
          }

          // maxAllowedYm는 이미 current(오늘 기준)으로 세팅되어 있음

          // 현재 보고있는 달이 max보다 크면(예: 브라우저가 다른 시간대 등) clamp
          const currentYm = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
          if (compareYm(currentYm, maxAllowedYm) > 0) {
            // 현재 보고있는 달을 max로 맞춤
            const [my, mm] = maxAllowedYm.split('-').map(Number);
            currentYear = my;
            currentMonth = mm - 1;
          }

           renderCalendar3();
         })
         .catch(err => {
                   console.log('fetchGoalDatesAndRender3 error:', err.message);
          // 에러시 기본값: 아무 데이터 없음 -> 이동 불가(최초달 == 현재달)
          emojiMap = {};
          allowedMonths = [];
          minAllowedYm = getCurrentYmString();
          maxAllowedYm = getCurrentYmString();
          renderCalendar3();
               });
     }


    function fetchMonthlyGoalView(year, month) {
      const ym = `${year}-${String(month).padStart(2, '0')}`;
      const el3 = document.getElementById('goal_id');

      // 현재 날짜 기준
const today = new Date();
const currentYear = today.getFullYear();
const currentMonth = today.getMonth() + 1; // 1~12

console.log(month);
console.log(currentMonth);
console.log('---------');

fetch(`/monthlyGoal/info/${ym}`)
  .then(res => {
          if (!res.ok) throw new Error('no goal');
          return res.json();
        })
 .then(data => {
    const title = data.title;
    const goal_id = data.id;
    const goalAddEl = document.getElementById('goal_add');
    const goalUpdateEl = document.getElementById('goal_update');
 // 1️⃣ 목표 타이틀 처리
    // 목표 타이틀
    if (data && data.title) {
        goalUpdateEl.textContent = `🌟 목표: ${title}`;
        goalUpdateEl.style.display = 'inline';
    } else {
        goalUpdateEl.style.display = 'none';
    }
console.log(data.title);

// goal_add 조건
if ((year === currentYear) && (month === currentMonth) && !(data && data.title)) {
    goalAddEl.style.display = 'inline';
} else {
    goalAddEl.style.display = 'none';
}

    // goal_id 값 설정 (존재할 때만)
    if (el3) {
        el3.value = goal_id || '';
    }

      // 2️⃣ 달성 내용 리스트 처리
    const listContainer = document.getElementById('goal_content_list');
    listContainer.innerHTML = ''; // 기존 내용 초기화
    if (data.contents && data.contents.length > 0) {
           listContainer.style.display = 'block'; // 추가: container 보이게
      data.contents.forEach(item => {
        const span = document.createElement('span'); // span 생성
        span.textContent = `📅${item.dateYmd}: ${item.content}`; // 텍스트 넣기
        span.style.display = 'block'; // 한 줄씩 띄우고 싶으면 block
        listContainer.appendChild(span);
    });
    }

  })
  .catch(err => {
  console.log('여기 ?');
    console.log(err.message);
    document.getElementById('goal_add').style.display = 'none';
    document.getElementById('goal_update').style.display = 'none';
    document.getElementById('goal_content_list').style.display = 'none';
  });
  }

</script>


<script>



  function goalMonthly() {

    const title = document.getElementById('goal_title').value;
    const month = document.getElementById('goal_month').value;
    // CSRF 토큰 가져오기
    const token = document.querySelector('meta[name="_csrf"]').content;
    const header = document.querySelector('meta[name="_csrf_header"]').content;

    fetch('/monthlyGoal/add', {
        method: 'POST',
        headers: {
              'Content-Type': 'application/json',
            [header]: token   // CSRF 헤더 추가
        },
        body: JSON.stringify({ title : title, dateym: month})
        })
        .then(response => {
         if (!response.ok) throw new Error('서버 오류');
            console.log('업데이트 성공');
            document.getElementById('goal_update').textContent = title;
            document.getElementById('goal_add').style.display = 'none';
            document.getElementById('goal_update').style.display = 'block';
            closeModal();
         })
         .catch(err => {
            console.error('업데이트 실패:', err);
    });
  }
</script>


</body>
</html>
