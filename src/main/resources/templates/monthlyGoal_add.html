<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/styles.css" rel="stylesheet"/>
    <title>모바일 입력 폼</title>
    <style>
<!--        label {-->
<!--          display: block;-->
<!--          margin-top: 16px;-->
<!--          margin-bottom: 6px;-->
<!--          font-weight: bold;-->
<!--        }-->

         .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      margin-bottom: 6px;
    }
    .label-row label {
      font-weight: bold;
    }

     input[type="color"] {
      width: 30px;
      height: 30px;
      border: none;
      padding: 0;
      background: none;
      cursor: pointer;
    }

        input[type="text"],
        textarea {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 8px;
          box-sizing: border-box;
          margin: 12px 0;
        }
        textarea {
          resize: vertical;
          min-height: 100px;
        }
        .save-btn {
          width: 100%;
          padding: 14px;
          font-size: 16px;
          background-color: black;
          color: white;
          cursor: pointer;
        }

    </style>
</head>
<body>
<div th:replace="~{nav.html::navbar}"></div>
<div class="container" style="margin-top:30px; padding:20px;">
    <div class="calendar-widget2" id="calendar3" style="width:100%;" >
        <!-- JavaScript로 채워짐 -->
    </div>
    <form id="monthlyForm" action="/monthlyGoal/addContent" method="post">


        <input type="hidden" class="goal-date" name="date" id="date" th:value="${date}">
        <!--      disabled는 값을 전달하지 않음   -->
        <input type="hidden" name="month" id="goal_month" th:value="${month}">
        <input type="hidden" name="goal_id" id="goal_id" >

        <input type="text" id="content" name="content" placeholder="오늘의 목표를 달성했나요? ">



        <button class="save-btn" type="submit" onclick="submitForm()">달 성 완 료</button>
    </form>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <span class="close-btn" onclick="closeModal()">×</span>
            <input type="text" name="goal_title" id="goal_title" placeholder="목표를 입력하세요" />
            <button class="modal-btn" onclick="goalMonthly()">저장하기</button>
        </div>
    </div>

</div>



<!-- STOMP & SockJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- 공통 WebSocket 연결 스크립트 -->
<script src="/common.js"></script>

<script>
    document.getElementById('monthlyForm').addEventListener('submit', function (event) {
      const content = document.getElementById('content').value.trim();
      const date = document.getElementById('date').value;

      if (!content) {
        alert("내용은 필수입니다.");
        event.preventDefault();
        return;
      }

    });

</script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
  fetchGoalDatesAndRender3();
    });

let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0 ~ 11

   function renderCalendar3() {
  const today = new Date();
  const calendar = document.getElementById('calendar3');

  const year = currentYear;
  const month = currentMonth;
  const date = today.getDate();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const monthName = `${month + 1}`;

  // 🔁 상단 바: 월 + ← → 버튼 추가
  calendar.innerHTML = `
    <div class='slide-bar-monthly'>
      <button onclick="changeMonth(-1)">←</button>
      <h3>${year}년 ${monthName}월</h3>
      <button onclick="changeMonth(1)">→</button>
      <span id="goal_add" onclick="openModal()"> 목표 지정하기 + </span>
      <span id="goal_update" style="display:none;"></span>
    </div>
  `;



  const days = document.createElement('div');
  days.className = 'days';

  const dayNames = ['월', '화', '수', '목', '금', '토', '일'];
  dayNames.forEach(name => {
    const d = document.createElement('div');
    d.className = 'day-header';
    d.textContent = name;
    days.appendChild(d);

  });

  const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

  for (let i = 0; i < startDay; i++) {
    const empty = document.createElement('div');
    days.appendChild(empty);
  }

  for (let i = 1; i <= lastDay.getDate(); i++) {
    const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    const d = document.createElement('div');
    d.className = 'day';

    if (i === date && month === today.getMonth() && year === today.getFullYear()) {
      d.classList.add('today');
    }

    if (emojiMap[fullDate]) {
      d.innerHTML = `<span class="emoji-day">${emojiMap[fullDate]}</span>`;
    } else {
      d.textContent = i;
    }

    days.appendChild(d);
  }

  calendar.appendChild(days);


<!--div 다 생성후에 작동해야 오류가 안난다 ~ -->
  fetchMonthlyGoalView();

}

// 🔁 월 변경 함수
function changeMonth(offset) {
  currentMonth += offset;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear -= 1;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear += 1;
  }
  renderCalendar3();
}


        function openModal() {
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('goal_title').value = '';
      document.getElementById('modalOverlay').style.display = 'none';

    }

    function fetchGoalDatesAndRender3() {
       fetch('/monthlyGoal/goalCount')  // 날짜만 주는 API
         .then(res => res.json())
//        날짜 배열을 받아서 각 날짜를 키로 하고 값은 항상 emoji인 객체(맵) 형태로 바꿔주는 것
         .then(dates => {
         console.log('goalcount옴');
           // 모든 날짜에 동일 이모지 할당
//           dates : ["2025-07-28", "2025-08-02"] 같은 배열
//           acc : 객체를 누적할 객체 (초기값 : {})
//           date : 현재 순회 중인 날짜 문자열
           emojiMap = dates.reduce((acc, date) => {
             acc[date] = '🌟';  // 객체의 key : date / 값 : emoji
             return acc;
           }, {});
           renderCalendar3();
         })
         .catch(err => {
                 console.log(err.message);  // 목표 없어도 정상 처리
                 emojiMap = {};             // ⛔ 없으면 빈 객체라도 초기화
                 renderCalendar3();          // ✅ 이모지 없어도 달력 그리기
               });
     }
</script>


<script>


    function fetchMonthlyGoalView() {
    const ym = new Date().toISOString().slice(0, 7); // '2025-08'

fetch(`/monthlyGoal/info/${ym}`)
  .then(res => {
    if (res.status === 204) {
    console.log('1');
      throw new Error("이번 달 목표 없음");
    }
    if (!res.ok) {
   console.log('2');
      throw new Error("서버 오류");
    }
    return res.json();
  })
  .then(data => {
  console.log('3');
    const title = data.title;
    const goal_id = data.id;
    console.log(title);
    const el1 = document.getElementById('goal_update');
const el2 = document.getElementById('goal_add');
const el3 = document.getElementById('goal_id');

console.log('goal_update:', el1);  // null이면 아직 없는 것
console.log('goal_add:', el2);
console.log('goal_id:', el3);
    document.getElementById('goal_update').textContent = `🌟 이번달 목표: ${title}`;
    document.getElementById('goal_update').style.display = 'inline';
    document.getElementById('goal_add').style.display = 'none';
    document.getElementById('goal_id').value = `${goal_id}`;
  })
  .catch(err => {
    console.log(err.message);
    document.getElementById('goal_add').style.display = 'inline';
    document.getElementById('goal_update').style.display = 'none';
  });
  }

  function goalMonthly() {

    const title = document.getElementById('goal_title').value;
    const month = document.getElementById('goal_month').value;

    fetch('/monthlyGoal/add', {
        method: 'POST',
        headers: {
              'Content-Type': 'application/json'
        },
        body: JSON.stringify({ title : title, dateym: month})
        })
        .then(response => {
         if (!response.ok) throw new Error('서버 오류');
            console.log('업데이트 성공');
            document.getElementById('goal_update').textContent = title;
            document.getElementById('goal_add').style.display = 'none';
            document.getElementById('goal_update').style.display = 'block';
            closeModal();
         })
         .catch(err => {
            console.error('업데이트 실패:', err);
    });
  }
</script>


</body>
</html>
