<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/styles.css" rel="stylesheet"/>
    <title>모바일 입력 폼</title>
    <style>
        /* 기존 CSS 스타일 ... */

        .label-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 6px;
            margin-bottom: 6px;
        }
        .label-row label {
            font-weight: bold;
        }

        input[type="color"] {
            width: 30px;
            height: 30px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .save-btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            background-color: black;
            color: white;
            cursor: pointer;
            margin-top: 16px;
        }

        #mapInfo {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            border: solid 1px #ccc;
            margin-bottom: 12px; /* 추가: 지도 아래 여백 */
        }

        .mapInfo-search-input-group { /* 추가: 장소 입력창과 검색 버튼을 묶기 위한 flex container */
            display: flex;
            align-items: center;
            margin: 12px 0;
        }

        .mapInfo-search-input-group input[type="text"] {
            flex-grow: 1; /* 입력창이 가능한 공간을 모두 차지하도록 */
            margin-bottom: 0; /* 기존 input[type="text"]의 margin-bottom 제거 */
        }

        .mapInfo-search-btn {
            /* width: 20%; */ /* 고정 너비 대신 content에 맞게 조절 */
            padding: 12px 15px; /* 버튼 패딩 조정 */
            margin-left: 10px; /* 입력창과의 간격 */
            background-color: black;
            color: white;
            border: none; /* 버튼 기본 테두리 제거 */
            border-radius: 8px; /* 통일된 border-radius */
            cursor: pointer;
            font-size: 16px;
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        }

        /* --- 모달 관련 CSS 추가 --- */
        .modal {
            display: none; /* 초기에는 숨김 */
            position: fixed; /* 고정 위치 */
            z-index: 1000; /* 다른 요소 위에 표시 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* 내용이 넘칠 경우 스크롤 */
            background-color: rgba(0,0,0,0.4); /* 배경을 어둡게 */
            justify-content: center; /* 수평 가운데 정렬 */
            align-items: center; /* 수직 가운데 정렬 */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* 가운데 정렬 (display: block일 때) */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* 모바일 환경에 맞게 너비 조정 */
            max-width: 500px; /* 최대 너비 설정 */
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute; /* 닫기 버튼을 우측 상단에 고정 */
            top: 22px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #menu_wrap {
            position: static; /* 모달 내부에 있으므로 absolute 해제 */
            width: 100%;
            height: 300px; /* 검색 결과 목록의 높이 */
            overflow-y: auto; /* 내용이 넘치면 스크롤 */
            margin-top: 10px;
            padding-right: 5px; /* 스크롤바 영역 고려 */
            box-sizing: border-box;
        }

        #placesList {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        #placesList .item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: left;
            cursor: pointer; /* 클릭 가능하도록 커서 변경 */
        }

        #placesList .item:last-child {
            border-bottom: none;
        }

        #placesList .item .markerbg {
            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png) no-repeat;
            display: inline-block;
            width: 36px;
            height: 37px;
            margin-right: 10px;
            background-position: 0px 0px; /* 초기 위치 */
        }
        /* marker number는 JavaScript에서 동적으로 설정 */

        #placesList .item .info {
            flex-grow: 1;
        }

        #placesList .item h5 {
            font-size: 14px;
        }

        #placesList .item span {
            font-size: 12px;
        }

        #placesList .item .info .gray {
            color: #8a8a8a;
        }

        #placesList .item .info .tel {
            color: #009900;
        }

        #pagination {
            margin-top: 10px;
            text-align: center;
        }

        #pagination a {
            display: inline-block;
            padding: 5px 10px;
            margin: 0 3px;
            border: 1px solid #eee;
            border-radius: 5px;
            color: black;
            text-decoration: none;
        }

        #pagination a.on {
            background-color: black;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div th:replace="~{nav.html::navbar}"></div>
<div class="container" style="margin-top:30px; padding:20px;">
    <form id="calendarForm" action="/addCalendar" method="post">
        <div class="label-row">
            <label for="title">제목</label>
            <input type="color" name="titleColor" id="titleColor" value="#3498db">
        </div>
        <input type="text" id="title" name="title" placeholder="제목을 입력하세요">
        <div class="label-row">
            <label for="content">내용</label>
        </div>

        <textarea id="content" name="content" placeholder="내용을 입력하세요"></textarea>
        <div style="display: flex;">
            <div style="width:100%">
                <div class="label-row">
                    <label for="sdate">시작 날짜</label>
                </div>

                <input type="date" id="sdate" name="sdate" th:value="${date}">

            </div>
            <div style="margin-left: 10px; width:100%">
                <div class="label-row">
                    <label for="edate">종료 날짜</label>
                </div>

                <input type="date" id="edate" name="edate" th:value="${date}">

            </div>

        </div>

        <div class="mapInfo-search-input-group"> <input type="text" id="map_keyword" name="map_keyword" placeholder="장소 입력">
            <button type="button" class="mapInfo-search-btn" onclick="openPlaceSearchModal()">검색</button> </div>

        <input type="hidden" id="mapChk" name="mapChk" >
        <input type="hidden" id="selectedPlaceName" name="selectedPlaceName">
        <input type="hidden" id="selectedPlaceAddress" name="selectedPlaceAddress">
        <input type="hidden" id="selectedPlaceLat" name="selectedPlaceLat">
        <input type="hidden" id="selectedPlaceLng" name="selectedPlaceLng">
        <input type="hidden" id="selectedPlaceUrl" name="selectedPlaceUrl">
        <!-- hidden input 하나로 여러 장소 관리 -->
        <input type="hidden" id="places" name="places">
        <div id="selectedPlaceInfo" style="margin-bottom: 12px; "></div>

        <div id="mapInfo"></div>
        <input type = "hidden" name = "filename" id="filename">
        <input type="file" onchange="getURL(this)">
        <button class="save-btn" type="submit">저장하기</button>
    </form>
</div>


<div id="placeSearchModal" class="modal">
    <div class="modal-content">

        <div id="modal_search_input_group" style="display: flex; margin-bottom: 10px; align-items: center;">
            <div style="flex: 6; margin-right: 10px;"> <input type="text" id="modal_map_keyword" placeholder="장소명 검색" style="width: 100%; margin-bottom: 0;">
            </div>
            <div style="flex: 3; margin-right: 10px;"> <button type="button" class="mapInfo-search-btn" onclick="searchPlacesInModal()" style="width: 100%; margin-left: 0;">검색</button>
            </div>
            <div style="flex: 1; text-align: right;"> <span class="close-button" onclick="closePlaceSearchModal()" style="position: static; float: none;">&times;</span>
            </div>
        </div>
        <div id="menu_wrap">
            <ul id="placesList"></ul>
            <div id="pagination"></div>
        </div>
    </div>
</div>

<script>
    let uploadedFileUrl = null;

    async function getURL(e){
        let file = e.files[0];
        let name = encodeURIComponent(file.name);
        let result = await fetch('/presigned-url?filename='+name);
        result = await result.text();

        let sendImg = await fetch(result, {
            method: 'PUT',
            body: e.files[0]
        })

        if(sendImg.ok){
<!--           document.querySelector('img').src = sendImg.url.split("?")[0]-->
<!--            // 파일이 성공적으로 업로드된 경우-->
        uploadedFileUrl = result.split("?")[0];
        document.getElementById('filename').value = uploadedFileUrl;
        }else {
            console.error('업로드 실패:', await sendImg.text());
        }
    }

    // 폼 제출 이벤트
const form = document.getElementById('calendarForm');
form.addEventListener('submit', function(event){
    // 파일 업로드 진행 중이면 제출 막기 (선택 사항)
    const fileInput = form.querySelector('input[type="file"]');
    if(fileInput.files.length > 0 && !uploadedFileUrl){
        event.preventDefault();
        alert('파일 업로드가 완료될 때까지 기다려주세요.');
    }
    // 파일 없거나 업로드 완료되면 그대로 제출
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script src="/common.js"></script>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=db0946b54e87a1652fbd99ff96a402de&libraries=services"></script>

<script>
    let mapInfo = new kakao.maps.Map(document.getElementById('mapInfo'), {
        center: new kakao.maps.LatLng(37.566826, 126.9786567),
        level: 3
    });

    let ps = new kakao.maps.services.Places();
    let selectedPlaces = [];
    let markers = [];

    // --- 모달 열기/닫기 ---
    function openPlaceSearchModal() {
        document.getElementById('placeSearchModal').style.display = 'flex';
        document.getElementById('modal_map_keyword').value = document.getElementById('map_keyword').value;
        searchPlacesInModal();
    }

    function closePlaceSearchModal() {
        document.getElementById('placeSearchModal').style.display = 'none';
    }

    window.onclick = function(e) {
        if(e.target == document.getElementById('placeSearchModal')) closePlaceSearchModal();
    }

    // --- 장소 검색 ---
    function searchPlacesInModal() {
        let keyword = document.getElementById('modal_map_keyword').value.trim();
        if (!keyword) { alert("키워드를 입력해주세요!"); return; }
        ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
        let listEl = document.getElementById('placesList');
        let pageEl = document.getElementById('pagination');
        listEl.innerHTML = '';
        pageEl.innerHTML = '';

        if (status === kakao.maps.services.Status.OK) {
            let bounds = new kakao.maps.LatLngBounds();
            data.forEach((place, i) => {
                bounds.extend(new kakao.maps.LatLng(place.y, place.x));
                let li = document.createElement('li');
                li.className = 'item';
                li.innerHTML = `<h5>${place.place_name}</h5><span>${place.road_address_name || place.address_name}</span>`;
                li.onclick = () => { selectPlace(place); closePlaceSearchModal(); };
                listEl.appendChild(li);
            });
            mapInfo.setBounds(bounds);

            for (let i = 1; i <= pagination.last; i++) {
                let a = document.createElement('a');
                a.href = '#';
                a.innerText = i;
                if (i === pagination.current) a.className = 'on';
                else a.onclick = (() => { return () => pagination.gotoPage(i); })();
                pageEl.appendChild(a);
            }
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            alert("검색 결과가 없습니다.");
        }
    }

    // --- 장소 선택 ---
    function selectPlace(place) {
        if (selectedPlaces.length >= 5) { alert("최대 5개까지 선택 가능합니다."); return; }

        let pos = new kakao.maps.LatLng(place.y, place.x);
        let marker = addMarker(pos, selectedPlaces.length, place.place_name);

        selectedPlaces.push({
            no: selectedPlaces.length + 1,
            name: place.place_name,
            address: place.road_address_name || place.address_name,
            lat: place.y,
            lng: place.x,
            url: place.place_url,
            marker: marker
        });

        updateSelectedPlacesUI();
    }

    // --- 마커 추가 ---
    function addMarker(position, idx, title) {
        let marker = new kakao.maps.Marker({ position: position });
        marker.setMap(mapInfo);
        markers.push(marker);
        return marker;
    }

    // --- 리스트/삭제 업데이트 ---
    function updateSelectedPlacesUI() {
        const container = document.getElementById('selectedPlaceInfo');
        container.innerHTML = '';

        selectedPlaces.forEach((p, idx) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';

            div.innerHTML = `<span>${idx + 1}. ${p.name} (${p.address})</span>`;

            const delBtn = document.createElement('button');
            delBtn.innerText = '❌';
            delBtn.style.marginLeft = '10px';
            delBtn.style.cursor = 'pointer';
            delBtn.onclick = function() { removePlace(idx); };

            div.appendChild(delBtn);
            container.appendChild(div);
        });

        // 서버 전송용 hidden input 업데이트
        document.getElementById('places').value = JSON.stringify(
            selectedPlaces.map(p => ({ no:p.no, name: p.name, address: p.address, lat: p.lat, lng: p.lng, url: p.url }))
        );
    }

    // --- 장소 삭제 ---
    function removePlace(index) {
          // 지도에서 마커 제거
    selectedPlaces[index].marker.setMap(null);

    // 배열에서 제거
    selectedPlaces.splice(index, 1);

    // 삭제 후 번호 재정렬
    selectedPlaces.forEach((p, i) => {
        p.no = i + 1;
    });

    updateSelectedPlacesUI();
    }

</script>

<script>
    const startInput = document.getElementById('sdate');
    const endInput = document.getElementById('edate');

    // 실시간: 시작일이 바뀌면 종료일 최소값 설정
    startInput.addEventListener('change', function () {
      if (startInput.value) {
        endInput.min = startInput.value;
      }
    });

    // 실시간: 종료일이 바뀌면 검증
    endInput.addEventListener('change', function () {
      if (startInput.value && endInput.value) {
        if (new Date(startInput.value) > new Date(endInput.value)) {
          alert("❗ 시작 날짜는 종료 날짜보다 늦을 수 없습니다.");
          endInput.value = "";
        }
      }
    });
</script>

<script>
    document.getElementById('calendarForm').addEventListener('submit', function (event) {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const startDate = document.getElementById('sdate').value;
      const endDate = document.getElementById('edate').value;

      if (!title) {
        alert("제목은 필수입니다.");
        event.preventDefault();
        return;
      }

      if (content.length < 10) {
        alert("내용은 10자 이상 입력해주세요.");
        event.preventDefault();
        return;
      }

      if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
        alert("시작일은 종료일보다 이전이어야 합니다.");
        event.preventDefault();
        return;
      }

      // 장소 정보가 선택되었는지 확인 (선택 사항)
      if (!document.getElementById('selectedPlaceName').value) {
          // alert("장소를 검색하고 선택해주세요.");
          // event.preventDefault();
          // return;
      }
    });
</script>

</body>
</html>